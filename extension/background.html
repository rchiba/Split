<!DOCTYPE html>
<!--
 * Copyright (c) 2010 The Chromium Authors. All rights reserved.  Use of this
 * source code is governed by a BSD-style license that can be found in the
 * LICENSE file.
-->
<html>
  <head>
   <script type="text/javascript" src="http://localhost:3000/nowjs/now.js"></script>
  </head>
  <body>
    <script>
    // Global window objects that are retained throughout the session
    var PrimaryWindow;
    var SecondaryWindow;
    var self = this;
    // init called once when background is loaded
    function init(){
        console.log('init triggered');
        chrome.windows.getCurrent(function(win){PrimaryWindow = win});
    }

    // setup called when "connect" is pressed in the popup
    function setup(key){
            console.log('setup triggered');
            if(!key){
                return
            }           
 
            // Connect to host to see if group is valid
            now.connect(key, function(res){
                console.log('connected to host with response '+JSON.stringify(res));
                if(res.status==1){
                    // if successful, then split the windows
                    splitScreen();
                }
                else{
                    // do nothing, maybe alert the user
                    connectionFail();
                }
            });
    }

    // This method runs when connection fails
    function connectionFail(){
        //stub
        console.log('connection Fail');
    }
    // This method arranges the windows and sets up the global window objects
    function splitScreen(){

        console.log('setting up the double windows');
        // get current window to determine spacings
        chrome.windows.getCurrent(function(win){   
            PrimaryWindow = win;
            // create the listener win on the left
            var newWinCfg={
                "url":"waiting.html",
                "width":win.width/2,
                "height":win.height,
                "left":win.left,
                "top":win.top,
                "focused":false,
                "type":"normal"
            }
            console.log('about to create new window');
            console.log(newWinCfg);
            chrome.windows.create(newWinCfg,function(secondaryWin){
                SecondaryWindow = secondaryWin;
                // resize the current (main) window
                var mainWinCfg={
                    "left":win.left+win.width/2,
                    "width":win.width/2,
                    "focused":true
                }
                console.log('About to update main win');
                console.log(mainWinCfg);
                chrome.windows.update(win.id,mainWinCfg,function(){
                    // All done
                });
            });
        });
    }// End splitScreen()

    // This method reverts the windows to the normal state
    function revertScreen(){

        console.log('setting up the single windows');
        
        // null secondarywindow global
        SecondaryWindow = null;

        // Resize main screen
        var originalCfg = {
            "width":PrimaryWindow.width,
            "left":PrimaryWindow.left
        }
        chrome.windows.update(PrimaryWindow.id,originalCfg);

    }// End revertScreen()

    // This method disconnects the user from the server
    function disconnect(){
        console.log('disconnecting '+this.user.clientId);
        var cid = this.user.clientId;
        this.getGroups(function(groups){
            for(i in groups){
                if(groups[i]!== 'everyone'){
                    groups[i].removeUser(cid)
                }
            }
        })
    }

    // This method decides what to do when a window is removed
    chrome.windows.onRemoved.addListener(function(wid){
        if(SecondaryWindow){
            console.log('secondary window exists');
            // If the secondary window is closed, revert screen and go back to normal mode
            if(wid==SecondaryWindow.id){
                revertScreen();
                disconnect();
            }
        }

    })


    // This method defines what happens after server sends a message
    now.receiveMessage = function(msg){
        console.log('received message from host');
		console.log(JSON.stringify(msg));
    	
		// Set secondary url to page
		chrome.windows.update(SecondaryWindow.id,{"url":msg.url});
	}


    // Triggered by contentScript when any changes happen on client broadcaster
    chrome.extension.onRequest.addListener(
        function(request,sender,sendResponse){
            self.getGroups(function(g){console.log('in groups ');console.log(g);});
            // If the primary window is sending the request, then process
            if(sender.tab.windowId === PrimaryWindow.id && SecondaryWindow !== null){
                    // Called when a new pages is loaded and window.onloads
                    if (request.action === 'windowOnload'){
                        console.log('background: windowOnload called');
                        chrome.windows.getLastFocused(function(win){
                            chrome.tabs.getSelected(win.id, function(tab){
                                console.log('background: url is '+tab.url);
                                var url = tab.url;
                                console.log('distributing message');
                                now.distributeMessage({'url':url});
                            })
                        })
                    }// End windowOnload
            }
        });// End addListener

    window.onload = function(){init()}
    init();

    </script>
  </body>
</html>
